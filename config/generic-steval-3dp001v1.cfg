# This file contains common pin mappings for STEVAL-3DP001V1 board.
# to use this config, the firmware should be compiled for the STM32F401ve

# See docs/Config_Reference.md for a description of parameters.
# Refer to https://www.st.com/en/motor-drivers/l6474.html for more info about the L6474 stepper driver


[stepper_x]
step_pin: PE14
dir_pin: !PE15
microsteps: 16
rotation_distance: 40
endstop_pin: ~!PD8
position_endstop: 0
position_max: 300
homing_speed: 50


[stepper_y]
step_pin: PB10
dir_pin: !PE9
microsteps: 16
rotation_distance: 40
endstop_pin: ~!PD9
position_endstop: 0
position_max: 255
homing_speed: 50


[stepper_z]
step_pin: PC6
dir_pin: PC0
microsteps: 16
rotation_distance: 8
endstop_pin: ~!PD10
position_endstop: 0
position_min: 0
position_max: 300


[extruder]
step_pin: PD12
dir_pin: PC13
microsteps: 16
rotation_distance: 7.921
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC7
sensor_type: EPCOS 100K B57560G104F
pullup_resistor: 1000  # for steval board 1k pull up resistor is used
sensor_pin: PA0
control: pid
pid_Kp: 24.575
pid_Ki: 1.085
pid_Kd: 139.157
min_temp: 0
max_temp: 265


[heater_bed]
heater_pin: PD14
sensor_type: EPCOS 100K B57560G104F
pullup_resistor: 1000  # for steval board 1k pull up resistor is used
sensor_pin: PC2
control: pid
pid_Kp: 71.255
pid_Ki: 0.956
pid_Kd: 1328.008
min_temp: 0
max_temp: 95


#layer fan
[fan]
pin: PE8 #fan3


[heater_fan extruder]
pin: PC4
heater : extruder


#[bltouch]
#sensor_pin: ^PD10
#control_pin:PB9
#x_offset: 39.4
#y_offset: 0
#z_offset: 2
#pin_move_time = 0.4
#probe_with_touch_mode: True #for bltouch v3 and v3.1
#sample_retract_dist: 5.0
#samples: 2


[mcu]
serial: /dev/serial/by-id/usb-STMicroelectronics_STM32_STLink_0674FF514852897267245621-if02
baud: 115200
restart_method: command


[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

########################################
# L6474 (motor drivers) configuration
########################################

[L6474 stepper_x]
#  These two parameters configure an SPI daisy chain.
#  Define the stepper position in the chain and the total chain lenght
chain_length: 6
chain_position: 1

spi_bus: spi1

#chip select line
cs_pin: PA4

# # Set the given registers during configuration of the L6474 motor driver.

# # Operating current
# # step of 31.25mA (range 31.25mA --> 4A)
# # formula: (targeted in mA / 31.25mA)-1
# driver_TVAL: 20    #(656.25mA)

# # Maximum fast decay duration
# # step of 2us ( range 2us --> 32us)
# # formula : (target value in us / 2us)-1
# driver_TOFF_FAST: 3 #(8us)  value used in Marlin4ST

# # Maximum fall step time
# # step 2us (range 2us --> 32us)
# # (target value in us / 2us)-1
# driver_FAST_STEP: 5  #(12us)   value used in Marlin4ST

# # The shortest on-time that guarentees a correct operation of the current control algo
# # step 0.5 us (range : 0.5us --> 64us)
# # formula (target value / 0.5us)-1
# driver_TON_MIN: 5  #(3us)    value used in Marlin4ST


# # The minimum OFF time value used by the current control
# # Step 0.5us (range 0.5us --> 64us)
# # Formula : (target value in us / 0.5)-1
# driver_TOFF_MIN: 21 #(11us)  value used in Marlin4ST


# # Overcurrent threashold
# # step 375mA (range 375mA --> 6A)
# # (target value in mA / 375)-1
# driver_OCD_TH: 2  #(1.125A)

# # microsteps
# #driver_STEP_SEL: 8  #(full step)
# #driver_STEP_SEL: 9  #(half step)
# #driver_STEP_SEL: 10 #(1/4)
# #driver_STEP_SEL: 11 #(1/8)
# driver_STEP_SEL: 12  #(1/16) #default

# # Synchronisation signal
# driver_SYNC_SEL: 8   # sync signal obtained starting from EL_POS[7]      (value used in Marlin4ST)
# #driver_SYNC_SEL: 9   # sync signal obtained starting from EL_POS[6]
# #driver_SYNC_SEL: 10  # sync signal obtained starting from EL_POS[5]
# #driver_SYNC_SEL: 11  # sync signal obtained starting from EL_POS[4]
# #driver_SYNC_SEL: 12  # sync signal obtained starting from EL_POS[3]


# #Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

# #Config Register

# # OSC_SEL and EXT_CLK set the system clock source
# # Internal oscillator
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0

# # The EN_TQREG sets if the torque regulation is performed through
# # the ADCIN voltage (external) or TVAL register (internal)
# driver_EN_TQREG: 0 #(internal)

# # The OC_SD sets wether or not an overcurrent event causes the bridges to turn off
# driver_OC_SD: 1

# # The POW_SR bits set the slew rate value of power bridge
# driver_POW_SR: 0

# # OFF time value
# # If TOFF value is less than TOFF_MIN, then TOFF = TOFF_MIN
# # Step 4 (range 4us --> 124us)
# # Formula : (target value in us / 4us)-1
# driver_TOFF: 11    #(48us)  value used in Marlin4ST

###############################################################

[L6474 stepper_y]
chain_length: 6
chain_position: 2
cs_pin: PA4

# #Default reg settings

# # (656.25mA/31.25mA)-1
# driver_TVAL: 20
# # (8us/2us)-1
# driver_TOFF_FAST: 3
# # (12us/2us)-1
# driver_FAST_STEP: 5
# # (3us/0.5us)-1
# driver_TON_MIN: 5
# # (11us/0.5)-1
# driver_TOFF_MIN: 21
# # (1125/375)-1
# driver_OCD_TH: 2
# # 1/16 microsteps
# driver_STEP_SEL: 12
# # EL_POS [7]
# driver_SYNC_SEL: 8

# #Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

# #Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11

###############################################################

[L6474 stepper_z]
chain_length: 6
chain_position: 3
cs_pin: PA4

# #Default reg settings
# (781.25mA/31.25mA)-1
# driver_TVAL: 24
# # (8us/2us)-1
# driver_TOFF_FAST: 3
# # (12us/2us)-1
# driver_FAST_STEP: 5
# # (3us/0.5us)-1
# driver_TON_MIN: 5
# # (11us/0.5)-1
# driver_TOFF_MIN: 21
# # (1125/375)-1
# driver_OCD_TH: 2
# # 1/16 microsteps
# driver_STEP_SEL: 12
# # EL_POS [7]
# driver_SYNC_SEL: 8

# #Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

# #Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11

###############################################################

[L6474 extruder]
chain_length: 6
chain_position: 4
cs_pin: PA4

# #Default reg settings
# # (656.25mA/31.25mA)-1
# driver_TVAL: 20
# # (8us/2us)-1
# driver_TOFF_FAST: 3
# # (12us/2us)-1
# driver_FAST_STEP: 5
# # (3us/0.5us)-1
# driver_TON_MIN: 5
# # (11us/0.5)-1
# driver_TOFF_MIN: 21
# # (1125/375)-1
# driver_OCD_TH: 2
# # 1/16 microsteps
# driver_STEP_SEL: 12
# # EL_POS [7]
# driver_SYNC_SEL: 8

# #Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

# #Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11

###############################################################

[L6474 dummy1]
chain_length: 6
chain_position: 5
cs_pin: PA4

# #Default reg settings
# # (250mA/31.25mA)-1
# driver_TVAL: 7
# # (8us/2us)-1
# driver_TOFF_FAST: 3
# # (12us/2us)-1
# driver_FAST_STEP: 5
# # (3us/0.5us)-1
# driver_TON_MIN: 5
# # (11us/0.5)-1
# driver_TOFF_MIN: 21
# # (750/375)-1
# driver_OCD_TH: 1
# # 1/16 microsteps
# driver_STEP_SEL: 12
# # EL_POS [7]
# driver_SYNC_SEL: 8

# #Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

# #Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11

###############################################################

[L6474 dummy2]
chain_length: 6
chain_position: 6
cs_pin: PA4

# #Default register settings

# # (250mA/31.25mA)-1
# driver_TVAL: 7
# # (8us/2us)-1
# driver_TOFF_FAST: 3
# # (12us/2us)-1
# driver_FAST_STEP: 5
# # (3us/0.5us)-1
# driver_TON_MIN: 5
# # (11us/0.5)-1
# driver_TOFF_MIN: 21
# # (750/375)-1
# driver_OCD_TH: 1
# # 1/16 microsteps
# driver_STEP_SEL: 12
# # EL_POS [7]
# driver_SYNC_SEL: 8

# #Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

# #Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11

########################################
# L6474 Reset pin handler
########################################

[output_pin rst_stepper_x]
pin: PE13
pwm: False
value: 1
shutdown_value: 0

[output_pin rst_stepper_y]
pin: PE10
pwm: False
value: 1
shutdown_value: 0

[output_pin rst_stepper_z]
pin: PC15
pwm: False
value: 1
shutdown_value: 0

[output_pin rst_extruder1]
pin: PC14
pwm: False
value: 1
shutdown_value: 0

[output_pin rst_extruder2]
pin: PE4
pwm: False
value: 1
shutdown_value: 0

[output_pin rst_extruder3]
pin: PE3
pwm: False
value: 1
shutdown_value: 0
